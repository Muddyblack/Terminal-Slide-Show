FROM node:20-alpine

WORKDIR /app

# Copy client package files
COPY client/package*.json ./client/
COPY config ./config/

WORKDIR /app/client

# Clean install with platform-specific flags and Rollup
RUN npm cache clean --force && \
    npm install

# Copy client project files
COPY client/ ./

# Build the frontend
RUN npm run build

# Runtime configuration
ENV VITE_HOST=0.0.0.0
EXPOSE 5173

# Use production mode for preview
ENV NODE_ENV=production

CMD ["npm", "run", "preview"]